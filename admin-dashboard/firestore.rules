rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for authentication and authorization
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().role in roles;
    }
    
    function belongsToDiocese(diocese) {
      return isAuthenticated() && getUserData().diocese == diocese;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isMuseumResearcher() {
      return hasRole('museum_researcher');
    }
    
    function isChanceryOffice() {
      return hasRole('chancery_office');
    }
    
    function isParishSecretary() {
      return hasRole('parish');
    }
    
    // Users collection - User profiles and authentication data
    match /users/{userId} {
      // Allow authenticated users to create their own profile
      // Use direct auth check (NOT isAuthenticated()) to avoid circular dependency
      // during initial profile creation when profile doesn't exist yet
      allow create: if request.auth != null && request.auth.uid == userId;

      // Users can read and update their own profile (using direct UID comparison to avoid circular dependency)
      // This includes updating requirePasswordChange flag when changing password on first login
      allow read, update: if isAuthenticated() && request.auth.uid == userId;

      // Chancery office can read all users in their diocese (admin users)
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'chancery_office' &&
                     (resource.data.diocese == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.diocese);

      // Chancery office can read ALL users (including public mobile app users) for management
      // Note: This allows collection queries. The app filters by accountType client-side.
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'chancery_office';

      // Museum researchers can read user profiles (for attribution)
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'museum_researcher';

      // Chancery office can create parish secretary accounts only in their diocese
      allow create: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'chancery_office' &&
                       request.resource.data.role == 'parish' &&
                       request.resource.data.diocese == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.diocese;

      // Chancery office can update user accounts in their diocese (admin users)
      allow update, delete: if isAuthenticated() &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'chancery_office' &&
                               resource.data.diocese == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.diocese;

      // Chancery office can update public users (for blocking/unblocking)
      allow update: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'chancery_office' &&
                       resource.data.accountType == 'public' &&
                       // Only allow updating specific fields (blocking-related)
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isBlocked', 'blockReason', 'blockedAt', 'blockedBy', 'isActive', 'lastUpdatedAt']);

      // Parish secretaries can read pending staff registrations for their own parish
      // This enables approval/rejection of new parish staff
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parish' &&
                     resource.data.parishId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.parishId &&
                     resource.data.status == 'pending';

      // Parish secretaries can read active/inactive staff in their parish
      // This enables the parish staff management UI (deactivation/reactivation)
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parish' &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active' &&
                     resource.data.role == 'parish' &&
                     resource.data.parishId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.parishId &&
                     resource.data.status in ['active', 'inactive'];

      // Parish secretaries can update pending staff in their parish (for approval/rejection)
      allow update: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parish' &&
                       resource.data.parishId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.parishId &&
                       resource.data.status == 'pending';

      // Parish secretaries can deactivate/reactivate staff in their parish
      // Only allows changing status between 'active' and 'inactive', plus metadata fields
      // Cannot deactivate their own account (enforced in application code)
      allow update: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'parish' &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active' &&
                       resource.data.parishId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.parishId &&
                       resource.data.status in ['active', 'inactive'] &&
                       request.resource.data.status in ['active', 'inactive'] &&
                       request.auth.uid != resource.data.uid &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'updatedAt', 'updatedBy', 'deactivatedAt', 'deactivatedBy', 'deactivationReason', 'reactivatedAt', 'reactivatedBy']);

      // Museum researchers can read pending museum staff registrations
      // This enables approval/rejection of new museum researchers
      // Only ACTIVE museum researchers can view pending registrations
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'museum_researcher' &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active' &&
                     resource.data.role == 'museum_researcher' &&
                     resource.data.status == 'pending';

      // Museum researchers can read active/inactive museum staff
      // This enables the museum staff management UI (deactivation/reactivation)
      allow read: if isAuthenticated() &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'museum_researcher' &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active' &&
                     resource.data.role == 'museum_researcher' &&
                     resource.data.status in ['active', 'inactive'];

      // Museum researchers can update pending museum staff (for approval/rejection)
      // Only ACTIVE museum researchers can approve/reject
      allow update: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'museum_researcher' &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active' &&
                       resource.data.role == 'museum_researcher' &&
                       resource.data.status == 'pending';

      // Museum researchers can deactivate/reactivate other museum staff
      // Only ACTIVE museum researchers can toggle status between active and inactive
      // Also handles legacy accounts without a status field (treated as active)
      allow update: if isAuthenticated() &&
                       exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'museum_researcher' &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active' &&
                       resource.data.role == 'museum_researcher' &&
                       (resource.data.status in ['active', 'inactive'] || !('status' in resource.data)) &&
                       request.resource.data.status in ['active', 'inactive'] &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'updatedAt', 'updatedBy', 'deactivatedAt', 'deactivatedBy', 'deactivationReason', 'reactivatedAt', 'reactivatedBy']);
    }
    
    // Churches collection - Main church data
    match /churches/{churchId} {
      // Everyone can read church data (public information)
      allow read: if true;
      
  // Parish secretaries can create churches in their diocese for their parish
  // Multiple churches per parish are allowed (e.g., different municipalities)
  allow create: if isParishSecretary() &&
           request.resource.data.diocese == getUserData().diocese &&
           request.resource.data.parishId == getUserData().parishId;

  // Parish secretaries can update churches that belong to their parish
  // For APPROVED churches: can only modify direct-publish fields and pendingChanges
  // For non-approved churches: can update all fields
  // Supports both: documents with parishId field AND legacy documents where document ID = parishId
  allow update: if isParishSecretary() &&
           (resource.data.parishId == getUserData().parishId || 
            (resource.data.parishId == null && churchId == getUserData().parishId)) &&
           resource.data.diocese == getUserData().diocese &&
           request.resource.data.diocese == resource.data.diocese &&
           // For approved churches, restrict which root fields can be modified
           // Sensitive fields must go through pendingChanges
           (resource.data.status != 'approved' ||
            request.resource.data.diff(resource.data).affectedKeys()
              .hasOnly(['contactInfo', 'massSchedules', 'assignedPriest', 'priest_assignment', 'assistantPriests', 'feastDay',
                        'images', 'photos', 'documents', 'virtualTour',
                        'tags', 'category', 'updatedAt', 'logoUrl',
                        'pendingChanges', 'hasPendingChanges']));

  // Chancery office can create churches in their diocese
  allow create: if isChanceryOffice() && request.resource.data.diocese == getUserData().diocese;

  // Chancery office can update churches in their diocese (cannot change diocese)
  // Chancery has full update access including applying pendingChanges to root fields
  allow update: if isChanceryOffice() &&
           resource.data.diocese == getUserData().diocese &&
           request.resource.data.diocese == resource.data.diocese;

  // Chancery office can delete churches in their diocese
  allow delete: if isChanceryOffice() && resource.data.diocese == getUserData().diocese;
      
      // Museum researchers can update heritage-related fields, historical information,
      // and process pendingChanges for heritage churches across dioceses
      allow update: if isMuseumResearcher() &&
                           request.resource.data.diff(resource.data).affectedKeys()
                             .hasOnly(['culturalSignificance', 'heritageNotes', 'heritageValidation',
                                       'heritageDeclaration', 'lastHeritageUpdate', 'heritageResearcher',
                                       'status', 'updatedAt', 'lastReviewedBy', 'lastReviewNote', 'lastStatusChange',
                                       'historicalBackground', 'description', 'architecturalStyle', 'architecturalFeatures',
                                       'heritageInformation', 'classification', 'foundingYear', 'founders', 'documents',
                                       'pendingChanges', 'hasPendingChanges', 'reviewedBy', 'reviewedAt', 'approvedAt', 'reviewNotes',
                                       'name', 'fullName', 'location', 'municipality', 'keyFigures',
                                       'religiousClassification', 'historicalDetails', 'preservationHistory',
                                       'restorationHistory', 'latitude', 'longitude']);
    }
    
    // Church heritage validation subcollection
    match /churches/{churchId}/heritage/{heritageId} {
      // Museum researchers can read and write heritage validations
      allow read, write: if isMuseumResearcher();
      
      // Chancery office can read heritage validations in their diocese
      allow read: if isChanceryOffice() && 
                     get(/databases/$(database)/documents/churches/$(churchId)).data.diocese == getUserData().diocese;
      
      // Parish secretaries can read heritage validations for their diocese churches
      allow read: if isParishSecretary() && 
                     get(/databases/$(database)/documents/churches/$(churchId)).data.diocese == getUserData().diocese;
    }
    
    // Church images subcollection
    match /churches/{churchId}/images/{imageId} {
      // Anyone can read images (public)
      allow read: if true;
      
      // Parish secretaries and chancery can manage images for their diocese
      allow create, update, delete: if (isParishSecretary() || isChanceryOffice()) && 
                                       get(/databases/$(database)/documents/churches/$(churchId)).data.diocese == getUserData().diocese;
      
      // Museum researchers can add heritage documentation images
      allow create, update: if isMuseumResearcher();
    }

    // Church import sessions subcollection - Parish document upload + parsing
    match /churches/{churchId}/import_sessions/{importId} {
      // Parish secretaries can create import sessions for their diocese
      allow create: if isParishSecretary() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.diocese == getUserData().diocese;

      // Owner can read their import sessions
      allow read: if isAuthenticated() && resource.data.createdBy == request.auth.uid;

      // Chancery office can read imports in their diocese (audit/support)
      allow read: if isChanceryOffice() &&
                     resource.data.diocese == getUserData().diocese;

      // Owner can update their import session
      allow update: if isAuthenticated() && resource.data.createdBy == request.auth.uid;

      // No deletes for audit integrity
      allow delete: if false;
    }
    
    // Parish information collection
    match /parishes/{parishId} {
      // Everyone can read parish data
      allow read: if true;
      
      // Chancery office can manage parishes in their diocese
      allow create, update, delete: if isChanceryOffice() && 
                                       (request.resource.data.diocese == getUserData().diocese ||
                                        resource.data.diocese == getUserData().diocese);
      
      // Parish secretaries can update their own parish
      allow update: if isParishSecretary() && 
                       resource.data.diocese == getUserData().diocese &&
                       (getUserData().parishId == parishId || getUserData().parish == parishId);
    }
    
    // Diocese information collection
    match /dioceses/{dioceseId} {
      // Everyone can read diocese information
      allow read: if true;
      
      // Only chancery office can update their own diocese info
      allow update: if isChanceryOffice() && 
                       dioceseId == getUserData().diocese;
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Chancery office can create and read reports for their diocese
      allow read, create: if isChanceryOffice() && 
                             (request.resource.data.diocese == getUserData().diocese ||
                              resource.data.diocese == getUserData().diocese);
      
      // Museum researchers can read heritage reports across dioceses
      allow read: if isMuseumResearcher() && 
                     resource.data.type == 'heritage';
    }
    
    // Feedback and reviews collection
    match /feedback/{feedbackId} {
      // Authenticated users can create feedback
      allow create: if isAuthenticated() &&
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.pub_user_id == request.auth.uid);

      // Anyone can read published feedback (for public reviews and diocese analytics)
      allow read: if resource.data.status == 'published';

      // Users can read their own feedback (regardless of status)
      allow read: if isAuthenticated() &&
                     (resource.data.userId == request.auth.uid ||
                      resource.data.pub_user_id == request.auth.uid);

      // Users can delete their own feedback
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid ||
                        resource.data.pub_user_id == request.auth.uid);

      // Chancery office can read ALL feedback in their diocese (for reports and moderation)
      allow read: if isChanceryOffice();

      // Parish secretaries can read all feedback (client-side filtering by diocese)
      allow read: if isParishSecretary();

      // Chancery office and parish secretaries can moderate feedback for churches in their diocese
      allow update: if (isChanceryOffice() || isParishSecretary()) &&
                       get(/databases/$(database)/documents/churches/$(resource.data.church_id)).data.diocese == getUserData().diocese;

      // Chancery office can delete inappropriate feedback in their diocese
      allow delete: if isChanceryOffice() &&
                       get(/databases/$(database)/documents/churches/$(resource.data.church_id)).data.diocese == getUserData().diocese;
    }
    
    // Church status audit logs
    match /church_status_audit/{auditId} {
      // Authenticated users can create audit logs when changing church status
      allow create: if isAuthenticated();

      // Chancery office and museum researchers can read audit logs for churches in their scope
      allow read: if (isChanceryOffice() && resource.data.diocese == getUserData().diocese) ||
                     isMuseumResearcher();
    }

    // User activity logs (audit trail) - LEGACY, use audit_logs instead
    match /logs/{logId} {
      // System can write logs (server-side)
      allow create: if isAuthenticated();

      // Chancery office can read logs for their diocese
      allow read: if isChanceryOffice() &&
                     resource.data.diocese == getUserData().diocese;
    }

    // =========================================================================
    // AUDIT LOGS COLLECTION - Chancellor Term-Based Audit Trailing
    // =========================================================================
    // This collection stores immutable audit logs for all actions performed
    // in the admin dashboard. Each entry is tied to a specific user (chancellor)
    // and includes term context for accountability across different terms.
    //
    // IMMUTABILITY: Audit logs cannot be updated or deleted to ensure
    // tamper-proof records for accountability and compliance.
    // =========================================================================
    match /audit_logs/{logId} {
      // Any authenticated user can create audit logs
      // This allows logging from all roles (chancery, parish, museum)
      allow create: if isAuthenticated();

      // Chancery office can read audit logs for their diocese
      // This enables viewing activity within their jurisdiction
      allow read: if isChanceryOffice() && 
                     resource.data.diocese == getUserData().diocese;

      // Museum researchers can read all audit logs (cross-diocese oversight)
      // This supports heritage review across both dioceses
      allow read: if isMuseumResearcher();

      // Parish secretaries can read audit logs for their own actions
      // and actions on resources in their parish
      allow read: if isParishSecretary() && 
                     (resource.data.actor.uid == request.auth.uid ||
                      resource.data.parishId == getUserData().parishId);

      // NO UPDATES OR DELETES - Audit logs are immutable
      // This ensures tamper-proof records for accountability
      allow update, delete: if false;
    }

    // =========================================================================
    // PARISH STAFF TERMS
    // =========================================================================
    // Tracks the historical terms of parish staff members.
    // Each term includes start/end dates and parish assignment details.
    // =========================================================================
    match /parish_staff_terms/{termId} {
      // All authenticated users can read term history
      allow read: if isAuthenticated();

      // Parish secretaries can create term records for their parish
      allow create: if isParishSecretary() || isChanceryOffice();

      // Parish secretaries can update terms within their parish,
      // Chancery office can update terms within their diocese
      allow update: if (isParishSecretary() && resource.data.parishId == getUserData().parishId) ||
                       (isChanceryOffice() && resource.data.diocese == getUserData().diocese);

      // Term records cannot be deleted (historical preservation)
      allow delete: if false;
    }

    // =========================================================================
    // PENDING CHANCELLOR REGISTRATIONS (via users collection)
    // =========================================================================
    // Note: Pending chancellor registrations are stored in the users collection
    // with status: 'pending' and role: 'chancery_office'. The rules in the
    // /users/{userId} match above handle these cases:
    // - Self-registration creates profile with status: 'pending'
    // - Active chancellors can approve/reject pending registrations
    // - Archived chancellors (status: 'ended') become read-only
    // =========================================================================
    
    // Configuration and system settings
    match /config/{configId} {
      // Everyone can read public configuration
      allow read: if resource.data.public == true;
      
      // Only chancery office can read/write diocese-specific config
      allow read, write: if isChanceryOffice() && 
                            resource.data.diocese == getUserData().diocese;
    }

    // Invites collection - Chancery invites parish secretaries
    match /invites/{inviteId} {
      // Allow read of invite details so invited user can load registration form
      allow read: if true;

      // Chancery office can create invites for their own diocese
      allow create: if isChanceryOffice() && request.resource.data.diocese == getUserData().diocese;

      // Allow invited user to mark invite as accepted after registration
      allow update: if isAuthenticated() &&
                      resource.data.status == 'pending' &&
                      request.resource.data.status == 'accepted' &&
                      request.resource.data.acceptedBy.uid == request.auth.uid;
    }

    // Announcements collection - Diocese and parish announcements
    match /announcements/{announcementId} {
      // Everyone can read announcements (public information)
      allow read: if true;

      // Chancery office can create announcements for their diocese
      allow create: if isChanceryOffice() &&
                       request.resource.data.diocese == getUserData().diocese;

      // Chancery office can update/delete announcements in their diocese
      // (includes archiving announcements created by parish secretaries)
      allow update, delete: if isChanceryOffice() &&
                               resource.data.diocese == getUserData().diocese;

      // Parish secretaries can create parish-scoped announcements in their diocese
      allow create: if isParishSecretary() &&
                       request.resource.data.diocese == getUserData().diocese &&
                       request.resource.data.scope == 'parish' &&
                       request.resource.data.parishId == getUserData().parishId;

      // Parish secretaries can update/delete their own parish announcements
      // (includes archiving their parish's announcements)
      allow update, delete: if isParishSecretary() &&
                               resource.data.diocese == getUserData().diocese &&
                               resource.data.scope == 'parish' &&
                               resource.data.parishId == getUserData().parishId;
    }

    // Church Visited collection - Physical visit tracking
    match /church_visited/{visitId} {
      // Anyone can read visit data (for public analytics and diocese reports)
      allow read: if true;

      // Authenticated users can create visit logs for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.pub_user_id == request.auth.uid &&
                       request.resource.data.visit_status == 'validated';

      // No updates or deletes allowed (immutable visit log)
      allow update, delete: if false;
    }

    // Notifications collection - System notifications for users
    match /notifications/{notificationId} {
      // Allow authenticated users to read notifications
      // Client-side filtering handles role/diocese matching
      // This is necessary because Firestore can't efficiently evaluate
      // complex security rules with getUserData() during collection queries
      allow read: if isAuthenticated();

      // All authenticated users can create notifications
      // This allows parish secretaries to notify chancery when submitting churches
      // and chancery/museum to notify parishes about status changes
      allow create: if isAuthenticated();

      // Authenticated users can update notifications to mark them as read
      allow update: if isAuthenticated() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'isRead']);

      // Only chancery office can delete notifications
      allow delete: if isChanceryOffice();
    }

    // Default deny rule for any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
